/*
    1º SELECT UNINDO DUAS TABELAS,NOTAS_FISCAIS NF E  ITENS_NOTAS_FISCAIS IT.
    2º BUSCANDO APENAS O MES E ANO DA DATA_VENDA.
    3º SOMANDO A QUANTIDADE DE VENDAS E AGRUPANDO POR CPF DO CLIENTE.
    4º TRANFORMANDO A CONSULTA EM UMA VIEW PARA MELHOR VISUALIZAÇÃO
*/
CREATE VIEW VW_LIMITE_POR_CLIENTE AS 
SELECT 
    NF.CPF,
    TO_CHAR(NF.DATA_VENDA,'MM-YYYY') AS MES_ANO,
    SUM(IT.QUANTIDADE) AS SOMA_QUANTIDADE    
FROM NOTAS_FISCAIS NF
INNER JOIN ITENS_NOTAS_FISCAIS IT
    ON NF.NUMERO = IT.NUMERO
GROUP BY NF.CPF,TO_CHAR(NF.DATA_VENDA,'MM-YYYY');    
    
    
/*
    5º FAZENDO UM JOIN COM A VW_LIMITE_POR_CLIENTE LC E TABELA_DE_CLIENTES TC.
    6º SELECIONANDO OS CAMPOS DESEJADOS PARA A CONSUTA.
    7º FAZNDO UM CASE PARA DESCOBRIR SE O LIMITE FOI EXCEDIDO OU NÃO.
    8º FILTRANDO APENAS PELOS VALORES DO MES_ANO DE '02-2016'
*/

SELECT 
    TC.CPF,
    TC.NOME,
    LC.MES_ANO,
    TC.VOLUME_DE_COMPRA,
    LC.SOMA_QUANTIDADE,
    LC.SOMA_QUANTIDADE - TC.VOLUME_DE_COMPRA AS LIMITE_EXCEDIDO,
    ROUND((1-(TC.VOLUME_DE_COMPRA / LC.SOMA_QUANTIDADE))*100,2) AS PERCENTUAL,
    (CASE WHEN LC.SOMA_QUANTIDADE > TC.VOLUME_DE_COMPRA THEN 'EXCEDIDO'
    ELSE 'NÃO EXCEDIDO'END) AS LIMITE
FROM TABELA_DE_CLIENTES TC
INNER JOIN VW_LIMITE_POR_CLIENTE LC
    ON TC.CPF = LC.CPF
WHERE LC.MES_ANO = '01-2016'
AND (TC.VOLUME_DE_COMPRA - LC.SOMA_QUANTIDADE) < 0 ;
    
    

