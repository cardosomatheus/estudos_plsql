
/*
    1º INNER JOIN ENTRE NOTAS_FISCAIS NF E ITENS_NOTAS_FISCAIS IT.
    2º SELECIONANDO OS CAMPOS DESEJADO.
    3º BUSCANDO APENAS O ANO DO CAMPO NF.DATA_VENDA
    4º SOMANDO O TOTAL DE QUANTIDADES E AGRUPANDO POR ANO IGUAL A 2016
    5º TRANFORMANDO A CONSULTA EM UMA VIEW PARA MELHOR VISUALIZAÇÃO
*/
CREATE VIEW VW_QUANTIDADE_GERAL AS 
SELECT
        EXTRACT(YEAR FROM NF.DATA_VENDA) AS ANO,
        SUM(IT.QUANTIDADE) AS QUANTIDADE_GERAL
    FROM NOTAS_FISCAIS NF
    INNER JOIN ITENS_NOTAS_FISCAIS IT
        ON NF.NUMERO = IT.NUMERO
    WHERE EXTRACT(YEAR FROM NF.DATA_VENDA) = '2016'
    GROUP BY EXTRACT(YEAR FROM NF.DATA_VENDA);
    

/*
    7º  INNER JOIN ENTRE NOTAS_FISCAIS NF, TABELA_DE_PRODUTOS TP E ITENS_NOTAS_FISCAIS IT. 
    8º  SELECIONANDO OS CAMPOS DESEJADO.
    9º  BUSCANDO APENAS O ANO DO CAMPO NF.DATA_VENDA
    10º SOMANDO O TOTAL DE QUANTIDADES E AGRUPANDO POR SABOR
    11º CONSULTANDO A QUANTIDADE GERAL DO VALOR DA VIEW VW_QUANTIDADE_GERAL
    12º ATRAVÉS DE UMA CALCULO DE ROUND((QUANTIDADE_POR_SABOR/QUANTIDADE_GERAL),4)*100 DESCUBRO A 
        PORCENTAGEM DE PARTIPAÇÃO QUE AQUELE SABOR TEM DA QUANTIDADE_GERAL E FORMATADA.
    13º FILTRO POR VALORES APENAS DO ANO DE 2016.
    14º ORDERNO DO MAIOR VALOR DE QUANTIDADE_POR_SABOR  ATÉ O MENOR VALOR
    15º COM ISSO TENHO UMA CONSULTA MOSTRANDO A PORCENTAGEM DE CADA SABOR POSSUI EM QUANTIDADE_GERAL ORDENADA 
        DO MAIOR PARA O MENOR.
*/
SELECT
    TP.SABOR,
    SUM(IT.QUANTIDADE)               AS QUANTIDADE_POR_SABOR,
    EXTRACT(YEAR FROM NF.DATA_VENDA) AS ANO,
    (SELECT QUANTIDADE_GERAL FROM VW_QUANTIDADE_GERAL) AS QUANTIDADE_GERAL,
    ROUND(SUM(IT.QUANTIDADE)/(SELECT QUANTIDADE_GERAL FROM VW_QUANTIDADE_GERAL),4)*100 AS PERCENTUAL_PARTICIPACAO
FROM TABELA_DE_PRODUTOS TP
INNER JOIN ITENS_NOTAS_FISCAIS IT 
    ON TP.CODIGO_DO_PRODUTO = IT.CODIGO_DO_PRODUTO
INNER JOIN NOTAS_FISCAIS NF
    ON NF.NUMERO = IT.NUMERO
WHERE EXTRACT(YEAR FROM NF.DATA_VENDA) = '2016'
GROUP BY TP.SABOR, EXTRACT(YEAR FROM NF.DATA_VENDA)
ORDER BY SUM(IT.QUANTIDADE) DESC;


